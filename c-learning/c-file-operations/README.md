
# 数据文件（二进制文件 / 文本文件）

## 二进制文件（又称映像文件）
- 用 fread / fwrite 进行读写
- 内存数据 “原样” 输出到外存，无格式转换，是内存数据的 “镜像”
- 按数据类型的字节数存储，人类不可读
- 想 "高效批量存数据（如结构体）" 或 "还原内存布局" → 选二进制文件

## 文本文件（又称ASCII文件）
- 用 fscanf / fprintf 进行读写
- 内存数据先转成 ASCII 字符，再存储到外存
- 按字符存储，1 个字符占 1 字节，人类可读
- 想 "人类能看懂 / 编辑文件内容" → 选文本文件

---

# 文件操作（打开文件 / 读写文件 / 关闭文件）

## 流程逻辑：打开（建立关联）→ 读写（操作数据）→ 关闭（释放资源）

## 打开文件（fopen）
### 函数原型：
```c
FILE *fopen(const char *filename, const char *mode);
```
#### 参数说明
- `filename`：字符串类型，指定要打开的文件名（可包含路径，如 `"./example.txt"`）。
- `mode`：字符串类型，指定文件的打开方式（见下方详细说明）。
- **返回值**：成功返回指向该文件的 `FILE*` 类型指针（文件句柄），失败返回 `NULL`（需检查返回值）。

### 打开方式
| 模式 | 类型   | 含义                                                                 |
|------|--------|----------------------------------------------------------------------|
| r    | 文本   | 只读打开，文件必须存在，否则失败                                     |
| w    | 文本   | 只写打开，文件不存在则创建，存在则清空原有内容                       |
| a    | 文本   | 追加写入，文件不存在则创建，写入时指针自动定位到文件末尾             |
| r+   | 文本   | 读写打开，文件必须存在，可同时读写                                   |
| w+   | 文本   | 读写打开，文件不存在则创建，存在则清空；支持先写后读（需调整指针）   |
| a+   | 文本   | 读写打开，文件不存在则创建；读可任意位置，写只能追加到末尾           |
| rb   | 二进制 | 二进制模式只读，其余同 `r`                                           |
| wb   | 二进制 | 二进制模式只写，其余同 `w`                                           |
| ab   | 二进制 | 二进制模式追加，其余同 `a`                                           |
| rb+  | 二进制 | 二进制模式读写，其余同 `r+`                                          |
| wb+  | 二进制 | 二进制模式读写，其余同 `w+`                                          |
| ab+  | 二进制 | 二进制模式读写，其余同 `a+`                                          |

### 打开文件意味着
1. 建立**程序与外部文件**的关联，操作系统为文件分配内核资源；
2. 系统创建**文件缓冲区**（内存区域），后续读写先操作缓冲区，而非直接读写磁盘；
3. 返回 `FILE*` 指针作为唯一操作句柄，所有后续文件操作（读写/调整指针）都需通过该指针完成；
4. 若打开失败（如路径错误、权限不足），返回 `NULL`，需提前判断避免程序崩溃。

## 读写文件（fread/fwrite/fscanf/fprintf）
### 1. 二进制读写（fread/fwrite）
#### fread 原型（读二进制文件到内存）：
```c
size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream);
```
##### 参数说明
- `ptr`：指向内存缓冲区的指针（存储读取到的数据）；
- `size`：单个数据项的字节数（如 `sizeof(int)`、`sizeof(结构体)`）；
- `nmemb`：要读取的**数据项个数**；
- `stream`：文件指针（fopen返回的句柄）；
- **返回值**：成功读取的实际数据项个数（若返回值 < nmemb，可能是到文件末尾或读取失败）。

#### fwrite 原型（写内存数据到二进制文件）：
```c
size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream);
```
##### 参数说明
- `ptr`：指向要写入数据的内存缓冲区（如数组、结构体变量）；
- `size`：单个数据项的字节数；
- `nmemb`：要写入的**数据项个数**；
- `stream`：文件指针；
- **返回值**：成功写入的实际数据项个数（若返回值 < nmemb，说明写入失败）。

### 2. 文本读写（fscanf/fprintf）
**和 scanf / printf 的用法几乎一致，只不过多了第一个参数 FILE***
#### fscanf 原型（按格式读文本文件到变量）：
```c
int fscanf(FILE *stream, const char *format, ...);
```
##### 参数说明
- `stream`：文件指针；
- `format`：格式控制串（同 `scanf`，如 `"%s"`、`"%d %f"`）；
- `...`：可变参数，接收数据的变量**地址**（如 `&num`、`str`）；
- **返回值**：成功读取的变量个数，失败/到文件末尾返回 `EOF`（宏，值为-1）。

##### 自定义扫描集规则（几乎可以顶替fgets）

- `%s`：默认匹配**非空白字符**（空格/换行/制表符均为分隔符），遇到就停止；
- `%[]`：自定义匹配的字符集合，精准控制“哪些字符要读、哪些不读”。

扫描集的语法很灵活，能精准控制读取范围：
| 写法          | 含义                                  | 示例场景                  |
|---------------|---------------------------------------|---------------------------|
| `%[a-z]`      | 只读取小写字母（遇到非小写字母停止）  | 读取纯小写字母的字符串    |
| `%[a-zA-Z ]`  | 只读取大小写字母 + 空格（其他字符停） | 读取带空格的纯字母名字    |
| `%[^, ]`      | 读取除了逗号、空格外的所有字符        | 按逗号/空格分隔数据       |
| `%[^\n]`      | 读取时仅遇到换行符才停止（不含换行符）| 相等于fgets，但不含末尾的 '\n'    |
| `%19[^\n]`    | 最多读取19个字符（避免缓冲区溢出）    | 限制读取长度，安全写法    |

#### 补充 fgets 原型（按行读取文本文件内容）：
```c
char *fgets(char *str, int n, FILE *stream);
```
##### 参数说明
- `str`：指向字符数组（缓冲区）的指针，用于存储读取到的文本内容；
- `n`：本次读取的**最大字符数**（包含字符串结束符 `\0`，因此实际最多读取 `n-1` 个有效字符）；
- `stream`：文件指针（可传入 `stdin` 读取控制台输入，或 `fopen` 返回的文件句柄读取文件）；
- **返回值**：
  - 成功：返回指向 `str` 的指针（与第一个参数地址相同）；
  - 失败/到达文件末尾（EOF）：返回 `NULL`（需注意：空行≠EOF，空行仍会返回 `str` 指针，内容为 `"\n\0"`）。
##### 读取终止条件（满足其一即停止）：
- 读取到 `n-1` 个字符（达到长度限制）；
- 读取到换行符 `\n`（会将 `\n` 一并存入 `str`）；
- 到达文件末尾（EOF）。

#### fprintf 原型（按格式写变量到文本文件）：
```c
int fprintf(FILE *stream, const char *format, ...);
```
##### 参数说明
- `stream`：文件指针；
- `format`：格式控制串（同 `printf`，如 `"%s"`、`"%d\n"`）；
- `...`：可变参数，要写入的变量（如 `num`、`"abc"`）；
- **返回值**：成功写入的字符总数，失败返回负数。

## 调整文件偏移量(fseek/ftell)
### fseek 原型（设置文件指针位置）：
```c
int fseek(FILE *stream, long offset, int whence);
```
#### 参数说明
- `stream`：文件指针；
- `offset`：偏移量（字节数，可正/负/0；正数向后移，负数向前移）；
- `whence`：偏移起始位置（系统宏）：
  - `SEEK_SET`：从文件开头开始偏移；
  - `SEEK_CUR`：从当前指针位置开始偏移；
  - `SEEK_END`：从文件末尾开始偏移；
- **返回值**：成功返回0，失败返回非0。

### ftell 原型（获取当前文件指针位置）：
```c
long ftell(FILE *stream);
```
#### 参数说明
- `stream`：文件指针；
- **返回值**：当前指针相对于文件开头的字节偏移量，失败返回 `-1L`。

## 关闭文件(fclose)
### 函数原型：
```c
int fclose(FILE *stream);
```
#### 参数说明
- `stream`：要关闭的文件指针；
- **返回值**：成功返回0，失败返回 `EOF`（极少出现，如缓冲区写入磁盘失败）。

### 关闭文件意味着
1. **刷新缓冲区**：将缓冲区中未写入磁盘的内容（如fprintf未落盘的数据）强制写入磁盘；
2. **释放资源**：释放操作系统为该文件分配的内核资源和文件缓冲区；
3. **断开关联**：程序与文件的关联终止，文件指针失效，不可再通过该指针操作文件；
4. 若不关闭文件：可能导致数据丢失（缓冲区未刷新）、系统资源泄漏（打开文件数有限制）。

---

### 易错提醒
1. **必须检查`fopen`返回值、必须关闭文件**；
2. **文本/二进制文件的核心区别：是否做格式转换，二进制更高效，文本更易读**；
3. **`fseek` 不仅能调整指针，还能触发缓冲区刷新，是“写后读”的关键操作**；
4. **缓冲区是文件操作的核心机制，`fflush/fseek/fclose` 都会触发缓冲区刷盘**。