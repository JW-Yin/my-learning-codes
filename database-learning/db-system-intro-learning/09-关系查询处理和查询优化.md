# 第9章 关系查询处理和查询优化

## 9.1 关系数据库系统的查询处理
### 9.1.1 查询处理步骤
#### 1. 查询分析
- 词法分析、语法分析
- 识别SQL关键字、属性名、关系名
- 语法检查

#### 2. 查询检查
- 语义检查
- 存取权限检查
- 完整性约束检查
- 视图消解
- 将SQL查询语句转换成内部表示（查询树/语法分析树）

#### 3. 查询优化
- 代数优化（逻辑优化）：关系代数表达式的等价变换
- 物理优化（非代数优化）：存取路径和底层操作算法的选择
- 基于规则、基于代价、基于语义的优化

#### 4. 查询执行
- 生成查询执行计划
- 代码生成器生成执行代码
- 执行并回送结果

### 9.1.2 实现查询操作的算法示例
#### 1. 选择操作的实现
- **全表扫描算法**：适用于小表或选择率低的情况；按照物理次序读入M块到内存，检查每个元组
- **索引扫描算法**：利用B+树索引或hash索引；先找到满足条件的元组指针，再到基本表中检索元组
- 选择率较低时，索引扫描优于全表扫描

#### 2. 连接操作的实现
- **嵌套循环算法**：外层循环每个元组，检索内层循环每个元组；适合各种连接操作，通用但效率可能较低
- **排序-合并算法**：适合等值连接，尤其当表已排序时；对连接属性排序后，扫描一遍即可完成连接
- **索引连接算法**：在一个表（如SC）的连接属性上有索引；对另一个表（如Student）的每个元组，通过索引查找匹配元组
- **hash join算法**：
  - 划分阶段（创建阶段）：对较小表按hash函数分散到hash桶
  - 试探阶段（连接阶段）：对另一个表散列，找到匹配桶并连接

## 9.2 关系数据库系统的查询优化
### 9.2.1 查询优化概述
- 关系数据库系统巨大成功的关键
- 用户只需提出“干什么”，无需指明“怎么干”
- 优化器优势：获取统计信息、自动重新优化、考虑数百种执行计划、集成复杂优化技术
- 查询代价：I/O代价 + CPU代价 + 内存代价 + 通信代价（分布式）
- 总目标：选择有效策略，使得查询代价较小（较优解）

### 9.2.2 一个实例
- [例9.3] 求选修了2号课程的学生姓名
- 三种等价的关系代数表达式：Q1（先笛卡儿积再选择）、Q2（先自然连接再选择）、Q3（先选择再连接）
- 查询效率对比：Q3（先做选择）代价远低于Q1和Q2
- 说明查询优化的必要性和基本思想（代数优化：先选择；物理优化：利用索引）

## 9.3 代数优化
### 9.3.1 关系代数表达式等价变换规则
1. 连接、笛卡儿积的交换律
2. 连接、笛卡儿积的结合律
3. 投影的串接定律
4. 选择的串接定律
5. 选择与投影操作的交换律
6. 选择与笛卡儿积的交换律
7. 选择与并的分配律
8. 选择与差运算的分配律
9. 选择对自然连接的分配律
10. 投影与笛卡儿积的分配律
11. 投影与并的分配律

### 9.3.2 查询树的启发式优化
- **典型启发式规则**：
  1. 选择运算应尽可能先做
  2. 投影运算和选择运算同时进行
  3. 把投影同其前或后的双目运算结合起来
  4. 把某些选择同在它前面的笛卡儿积结合成一个连接运算
  5. 找出公共子表达式
- **关系表达式的优化算法**：
  1. 利用等价变换规则，把形如σF1∧F2∧…∧Fn(E)的表达式转换为σF1(σF2(…(σFn(E))…))
  2. 对每一个选择，利用等价变换规则4~9尽可能把它移到树的叶端
  3. 对每一个投影，利用等价变换规则3, 5, 10, 11尽可能把它移向树的叶端
  4. 合并选择和投影的串接
  5. 对语法树的内结点分组
- [例9.4] SQL语句的代数优化示例：将选择σSC.Cno='2'移到叶端，得到优化后的查询树

## 9.4 物理优化
### 9.4.1 基于启发式规则的存取路径选择优化
#### 1. 选择操作的启发式规则
- 小关系：使用全表顺序扫描
- 大关系：
  1. 主码=值：选择主码索引
  2. 非主属性=值：估算结果比例，<10%用索引扫描，否则全表扫描
  3. 非等值或范围查询：估算选择率，<10%用索引扫描，否则全表扫描
  4. AND连接的合取选择条件：优先组合索引，否则全表扫描
  5. OR连接的析取选择条件：一般使用全表顺序扫描

#### 2. 连接操作的启发式规则
1. 两个表已按连接属性排序：选用排序-合并算法
2. 一个表在连接属性上有索引：选用索引连接算法
3. 一个表较小：选用hash join算法
4. 最后选择嵌套循环算法，并选择较小的表作为外表

### 9.4.2 基于代价估算的优化
#### 1. 统计信息
- 对每个基本表：元组总数(N)、元组长度(l)、占用的块数(B)、溢出块数(BO)
- 对基本表的每个列：不同值的个数(m)、最大值、最小值、索引类型
- 对索引（如B+树）：层数(L)、不同索引值个数、索引的选择基数(S)、叶结点数(Y)

#### 2. 代价估算示例
- **全表扫描算法**：cost = B（如果选择条件是“码=值”，则cost = B/2）
- **索引扫描算法**：
  - 码=值（主索引）：cost = L + 1
  - 非码属性等值比较（B+树）：cost = L + S（最坏情况）
  - 范围比较：cost = L + Y/2 + B/2（可进一步修正）
- **嵌套循环连接算法**：cost = Br + BrBs/(K-1)（如需写回磁盘，需加上结果写回代价）
- **排序-合并连接算法**：若已排序，cost = Br + Bs + (Frs*Nr*Ns)/Mrs；若需排序，另加排序代价≈ (2*B)+(2*B*log₂B)
- **语义优化示例**：利用完整性约束（学生年龄15-55岁）发现查询条件Sage>200错误，直接返回空结果

## *9.5 查询计划的执行
- **自顶向下的执行方式**：被动、需求驱动；顶端操作符发出需求，向下传递至叶子结点
- **自底向上的执行方式**：主动；叶子结点产生元组放入缓冲区，父结点取用并产生自己的输出

## 9.6 小结
- 查询处理是RDBMS的核心，查询优化是关键
- 本章讲解查询处理步骤、查询操作算法、代数优化、物理优化
- 掌握优化方法概念，通过实验分析查询计划和代价，优化系统性能
- 复杂查询需结合RDBMS优化规律和手工调整

