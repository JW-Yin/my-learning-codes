# 《数据库系统概论（第5版）》第三章 关系数据库标准语言SQL大纲

## 第3章 关系数据库标准语言SQL

### 3.1 SQL概述

#### 3.1.1 SQL的产生与发展
- **发展历程**
  - 1974年由Boyce和Chamberlin提出，最初叫Sequel
  - 1986年ANSI批准SQL作为关系数据库语言的美国标准（SQL-86）
  - 1987年ISO通过SQL标准
  - 后续版本：SQL/89、SQL/92、SQL/99、SQL 2003、SQL 2008、SQL 2011
- **标准化**
  - 不同数据库厂商对SQL的支持程度不同
  - 通常支持SQL/92大部分功能及后续版本部分新特性

#### 3.1.2 SQL的特点
- **综合统一**
  - 集数据定义、数据操纵、数据控制功能于一体
  - 语言风格统一，可独立完成数据库生命周期全部活动
- **高度非过程化**
  - 只需提出"做什么"，无需指明"怎么做"
  - 存取路径由系统自动选择
- **面向集合的操作方式**
  - 操作对象和结果都是元组的集合
- **多种使用方式**
  - 独立语言：联机交互使用
  - 嵌入式语言：嵌入高级语言程序
- **语言简洁易用**
  - 核心功能只用9个动词
  - 接近英语口语，易学易用

#### 3.1.3 SQL的基本概念
- **三级模式结构支持**
  - 外模式：视图和部分基本表
  - 模式：基本表
  - 内模式：存储文件
- **基本表（base table）**
  - 独立存在的表
  - 一个关系对应一个基本表
- **视图（view）**
  - 从一个或多个基本表导出的表
  - 虚表，不独立存储数据
  - 只存放定义，数据仍存放在基本表中
- **存储文件（stored file）**
  - 逻辑结构组成内模式
  - 物理结构对用户隐蔽

### 3.2 学生-课程数据库
- **模式定义**
  - 学生-课程模式S-T
- **表结构**
  - 学生表：Student(Sno, Sname, Ssex, Sage, Sdept)
  - 课程表：Course(Cno, Cname, Cpno, Ccredit)
  - 选课表：SC(Sno, Cno, Grade)
- **数据示例**
  - 提供各表的具体数据示例

### 3.3 数据定义

#### 3.3.1 模式的定义与删除
- **定义模式**
  - CREATE SCHEMA <模式名> AUTHORIZATION <用户名>
  - 可包含CREATE TABLE、CREATE VIEW和GRANT子句
- **删除模式**
  - DROP SCHEMA <模式名> <CASCADE|RESTRICT>
  - CASCADE：级联删除所有数据库对象
  - RESTRICT：有限制删除（有下属对象时拒绝删除）

#### 3.3.2 基本表的定义、删除与修改
- **定义基本表**
  - CREATE TABLE <表名> (<列名><数据类型>[列级完整性约束条件], ...)
  - 完整性约束：PRIMARY KEY、UNIQUE、NOT NULL、FOREIGN KEY
- **数据类型**
  - 字符型：CHAR(n)、VARCHAR(n)
  - 整数型：INT、SMALLINT、BIGINT
  - 浮点型：REAL、DOUBLE PRECISION、FLOAT(n)
  - 定点数：NUMERIC(p,d)、DECIMAL(p,d)
  - 日期时间型：DATE、TIME、TIMESTAMP
  - 其他：BOOLEAN、INTERVAL、CLOB、BLOB
- **模式与表**
  - 三种定义所属模式的方法
  - 搜索路径（search path）确定对象所属模式
- **修改基本表**
  - ALTER TABLE <表名>
  - 操作：ADD COLUMN、ADD约束、DROP COLUMN、DROP CONSTRAINT、ALTER COLUMN
- **删除基本表**
  - DROP TABLE <表名> [RESTRICT|CASCADE]
  - 不同DBMS处理策略比较：Kingbase ES、Oracle、SQL Server

#### 3.3.3 索引的建立与删除
- **索引类型**
  - 顺序文件索引、B+树索引、散列索引、位图索引
- **建立索引**
  - CREATE [UNIQUE] [CLUSTER] INDEX <索引名> ON <表名>(<列名>[次序], ...)
- **修改索引**
  - ALTER INDEX <旧索引名> RENAME TO <新索引名>
- **删除索引**
  - DROP INDEX <索引名>

#### 3.3.4 数据字典
- **作用**
  - 记录数据库中所有定义信息
  - 关系模式定义、视图定义、索引定义、完整性约束、用户权限、统计信息等
- **实现**
  - 关系数据库管理系统内部的一组系统表
  - 执行SQL数据定义语句时更新数据字典

### 3.4 数据查询

#### 3.4.1 单表查询
- **选择表中的若干列**
  - 查询指定列
  - 查询全部列（SELECT *）
  - 查询经过计算的值（算术表达式、字符串常量、函数）
  - 使用列别名
- **选择表中的若干元组**
  - 消除取值重复的行（DISTINCT）
  - 查询满足条件的元组
    - 比较大小：=、>、<、>=、<=、!=、<>、!>、!<
    - 确定范围：BETWEEN...AND、NOT BETWEEN...AND
    - 确定集合：IN、NOT IN
    - 字符匹配：LIKE、NOT LIKE（通配符%和_，ESCAPE转义）
    - 涉及空值：IS NULL、IS NOT NULL
    - 多重条件：AND、OR、NOT
- **ORDER BY子句**
  - 按一个或多个属性列排序
  - ASC（升序，默认）、DESC（降序）
  - 空值排序由具体系统实现决定
- **聚集函数**
  - COUNT(*)：统计元组个数
  - COUNT([DISTINCT|ALL]<列名>)：统计列中值个数
  - SUM([DISTINCT|ALL]<列名>)：计算总和（数值型）
  - AVG([DISTINCT|ALL]<列名>)：计算平均值（数值型）
  - MAX([DISTINCT|ALL]<列名>)：求最大值
  - MIN([DISTINCT|ALL]<列名>)：求最小值
- **GROUP BY子句**
  - 将查询结果按列值分组
  - HAVING短语：筛选满足条件的组
  - WHERE与HAVING区别：WHERE作用于基本表，HAVING作用于组

#### 3.4.2 连接查询
- **等值与非等值连接查询**
  - 连接条件：[<表名1>.]<列名1> <比较运算符> [<表名2>.]<列名2>
  - 等值连接：比较运算符为=
  - 自然连接：特殊的等值连接，取消重复列
- **自身连接**
  - 一个表与其自身连接
  - 需要为表取别名
- **外连接**
  - 左外连接（LEFT OUTER JOIN）：保留左边关系所有元组
  - 右外连接（RIGHT OUTER JOIN）：保留右边关系所有元组
  - 全外连接（FULL OUTER JOIN）：保留两边关系所有元组
- **多表连接**
  - 两个以上表进行连接
  - 通常先进行两表连接，再与第三表连接

#### 3.4.3 嵌套查询
- **概念**
  - 查询块嵌套在另一个查询块的WHERE或HAVING条件中
  - 外层查询（父查询）、内层查询（子查询）
  - 子查询中不能使用ORDER BY子句
- **带有IN谓词的子查询**
  - 子查询结果往往是一个集合
- **带有比较运算符的子查询**
  - 子查询返回单值时使用比较运算符
- **带有ANY(SOME)或ALL谓词的子查询**
  - 子查询返回多值时使用
  - 与比较运算符结合使用
  - 与聚集函数的等价转换关系
- **带有EXISTS谓词的子查询**
  - 存在量词∃
  - 不返回数据，只产生逻辑真值true或false
  - NOT EXISTS：内层查询结果为空时返回真值
  - 实现全称量词（∀）和逻辑蕴涵查询

#### 3.4.4 集合查询
- **集合操作类型**
  - 并操作：UNION
  - 交操作：INTERSECT
  - 差操作：EXCEPT
- **注意事项**
  - 参加集合操作的各查询结果列数必须相同
  - 对应项的数据类型必须相同
- **操作符**
  - UNION：自动去掉重复元组
  - UNION ALL：保留重复元组

#### 3.4.5 基于派生表的查询
- **概念**
  - 子查询出现在FROM子句中
  - 生成的临时派生表成为主查询的查询对象
- **使用**
  - 可指定属性列名
  - 无聚集函数时可不指定属性列
  - 必须为派生表指定别名

#### 3.4.6 SELECT语句的一般格式
- **完整语法**
  - SELECT [ALL|DISTINCT] <目标列表达式> [别名]...
  - FROM <表名或视图名> [别名]... | (<SELECT语句>) [AS] <别名>
  - [WHERE <条件表达式>]
  - [GROUP BY <列名1> [HAVING <条件表达式>]]
  - [ORDER BY <列名2> [ASC|DESC]]
- **目标列表达式格式**
  - *
  - <表名>.*
  - COUNT([DISTINCT|ALL]*)
  - [<表名>.]<属性列名表达式>...
- **聚集函数格式**
  - 作用于属性列或整个查询结果
- **WHERE条件表达式格式**
  - 属性列与常量、属性列与属性列的比较
  - 属性列 [NOT] BETWEEN 常量 AND 常量
  - 属性列 [NOT] IN (常量1, 常量2, ...) | (<SELECT语句>)
  - 属性列 [NOT] LIKE <匹配串>
  - 属性列 IS [NOT] NULL
  - [NOT] EXISTS (SELECT语句)
  - 条件表达式的逻辑组合

### 3.5 数据更新

#### 3.5.1 插入数据
- **插入元组**
  - INSERT INTO <表名> [(<属性列1>, <属性列2>...)] VALUES (<常量1>, <常量2>...)
  - INTO子句指定属性列，未出现属性列取空值
  - 未指定属性列时，新元组必须在每个属性列上均有值
- **插入子查询结果**
  - INSERT INTO <表名> [(<属性列1>, <属性列2>...)] 子查询
  - 可一次插入多个元组

#### 3.5.2 修改数据
- **UPDATE语句**
  - UPDATE <表名> SET <列名>=<表达式> [, <列名>=<表达式>]... [WHERE <条件>]
  - 修改指定表中满足WHERE条件的元组
  - 省略WHERE子句时修改所有元组
- **带子查询的修改**
  - 子查询嵌套在UPDATE语句中构造修改条件

#### 3.5.3 删除数据
- **DELETE语句**
  - DELETE FROM <表名> [WHERE <条件>]
  - 删除指定表中满足WHERE条件的所有元组
  - 省略WHERE子句时删除所有元组
- **带子查询的删除**
  - 子查询嵌套在DELETE语句中构造删除条件

### 3.6 空值的处理

#### 3.6.1 空值的产生
- **插入空值**
  - 插入语句中未赋值的属性
  - 显式插入NULL值
- **修改为空值**
  - UPDATE语句将属性值改为NULL
- **外连接产生空值**
- **空值的关系运算产生空值**

#### 3.6.2 空值的判断
- **IS NULL**
  - 判断属性值是否为空
- **IS NOT NULL**
  - 判断属性值是否非空

#### 3.6.3 空值的约束条件
- **不允许取空值的情况**
  - NOT NULL约束属性
  - UNIQUE限制属性
  - 码属性

#### 3.6.4 空值的算术运算、比较运算和逻辑运算
- **算术运算**
  - 空值与任何值的算术运算结果为空值
- **比较运算**
  - 空值与任何值（包括空值）的比较运算结果为UNKNOWN
- **逻辑运算**
  - 三值逻辑：TRUE、FALSE、UNKNOWN
  - AND、OR、NOT真值表
- **查询处理**
  - 只有使WHERE和HAVING子句中条件为TRUE的元组才被输出
  - 包含空值的查询需特殊处理

### 3.7 视图

#### 3.7.1 定义视图
- **建立视图**
  - CREATE VIEW <视图名> [(<列名>, <列名>...)] AS <子查询> [WITH CHECK OPTION]
  - 子查询：任意的SELECT语句
  - WITH CHECK OPTION：对视图更新操作时保证满足视图定义条件
- **视图属性列**
  - 全部省略或全部指定
  - 必须明确指定列名的情况：
    - 目标列是聚集函数或列表达式
    - 多表连接时出现同名列
    - 需要为列启用新名字
- **视图类型**
  - 行列子集视图：从单个基本表导出，保留主码
  - 基于多个基本表的视图
  - 基于视图的视图
  - 带表达式的视图

#### 3.7.2 查询视图
- **视图消解（view resolution）**
  - 从数据字典中取出视图定义
  - 把视图定义的子查询与用户查询结合转换为等价的基本表查询
  - 执行修正后的查询
- **视图查询与基本表查询的相似性**
  - 用户视角：视图如同基本表
  - DBMS实现：需要转换为对基本表的查询

#### 3.7.3 更新视图
- **更新限制**
  - 一般只允许更新行列子集视图
  - DBMS实现差异：不同系统对视图更新能力不同
- **可更新视图条件**
  - 由单个基本表导出
  - 包含基本表主码或候选码
  - 视图属性来自属性列而非表达式或聚集函数
  - 查询中不包含DISTINCT、GROUP BY、HAVING等
- **WITH CHECK OPTION**
  - 保证更新后元组仍满足视图定义条件

#### 3.7.4 视图的作用
- **简化用户操作**
  - 隐藏复杂查询，简化数据操作
- **提供多种视角**
  - 不同用户以不同方式看待同一数据
- **提供逻辑数据独立性**
  - 应用程序不受数据库逻辑结构变化影响
- **对机密数据提供安全保护**
  - 通过视图隐藏敏感数据
- **更清晰的查询表达**
  - 适当视图使查询更清晰易理解

---
