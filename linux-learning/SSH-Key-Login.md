# 笔记：Linux服务器SSH密钥登录配置（替代密码登录）
## 一、操作背景
为了替代“密码登录SSH”（易被暴力破解），配置**公钥-私钥验证登录**，实现服务器仅允许密钥免密登录，提升安全性。


## 二、核心逻辑
- **公钥（`id_rsa.pub`）**：公开文件，上传到服务器，用于“验证私钥的合法性”；
- **私钥（`id_rsa`）**：私密文件，仅保存在本地电脑，是“登录服务器的唯一钥匙”；
- 登录时，服务器用公钥验证本地私钥，匹配则免密登录，无需输入密码。


## 三、详细操作步骤（Windows+Linux服务器）
### 步骤1：Windows本地生成SSH密钥对（CMD/PowerShell执行）
操作内容：生成RSA 4096位密钥对（安全性高）
```cmd
C:\Users\你的Windows用户名>ssh-keygen -t rsa -b 4096
```
- 执行时全程按**回车默认**（无需设置密钥密码，新手简化）；
- 密钥保存路径：`C:\Users\你的Windows用户名\.ssh\`
  - 公钥：`id_rsa.pub`（后续上传到服务器）
  - 私钥：`id_rsa`（本地保管，绝不能泄露/删除）


### 步骤2：服务器端配置公钥（CMD连接服务器后执行）
#### 2.1 密码登录服务器（这将是最后一次用密码登录）
```cmd
C:\Users\你的Windows用户名>ssh 你的服务器用户名@服务器IP
```
- 首次登录需输入`yes`确认服务器真实性，再输入`dev`用户密码。


#### 2.2 在服务器创建/确认`.ssh`目录（存放公钥的专用目录）
```bash
mkdir -p ~/.ssh
```
- 说明：`~`代表当前用户（dev）的家目录（`/home/dev`），`-p`表示“目录不存在则创建，存在则忽略”。


#### 2.3 写入公钥到授权文件（`authorized_keys`）
1. 打开本地`id_rsa.pub`文件，全选复制内容；
2. 在服务器终端执行：
```bash
# 打开授权文件（无则自动创建）
nano ~/.ssh/authorized_keys
```
3. 右键粘贴公钥内容 → 按`Ctrl+O`保存 → 按回车确认文件名 → 按`Ctrl+X`退出。


#### 2.4 设置关键权限（SSH强制要求，否则密钥登录失败）
```bash
# .ssh目录仅当前用户可访问
chmod 700 ~/.ssh
# 授权文件仅当前用户可读写
chmod 600 ~/.ssh/authorized_keys
```


### 步骤3：测试SSH免密登录（验证配置）
1. 退出服务器：
```bash
exit
```
2. 回到Windows CMD，重新连接：
```cmd
C:\Users\你的Windows用户名>ssh 你的服务器用户名@服务器IP
```
- 成功标志：**无需输入密码，直接进入服务器终端**。


### 步骤4：关闭服务器SSH密码登录（彻底加固）
1. 免密登录服务器后，提权编辑SSH配置文件：
```bash
sudo nano /etc/ssh/sshd_config
```
- 输入用户密码验证sudo权限。


2. 修改配置项（按`Ctrl+W`搜索关键词快速定位）：
```ini
# 关闭密码登录（关键）
PasswordAuthentication no
# 关闭挑战式验证（辅助加固）
ChallengeResponseAuthentication no
# 确保公钥登录开启（默认已开）
PubkeyAuthentication yes
```


3. 重启SSH服务使配置生效（Ubuntu/Debian用此命令）：
```bash
sudo systemctl restart sshd
```
- 重启后当前连接会断开，属于正常现象。


## 四、最终验证（确保配置生效）
1. **免密登录验证**：新开CMD窗口，执行`ssh 你的服务器用户名@服务器IP`，仍能免密登录；使用crt连接时，设置PublicKey为本地私钥后可以连接到服务器；
2. **密码登录失效验证**：用无本地私钥的设备连接，会提示`Permission denied (publickey)`，无法进入密码输入环节。


## 五、注意事项&避坑点
1. **私钥/公钥区分**：
   - 公钥：`id_rsa.pub`（可上传服务器，公开）；
   - 私钥：`id_rsa`（仅本地存，泄露=服务器被入侵）。
2. **权限必须严格**：`.ssh`目录权限`700`、`authorized_keys`权限`600`，否则SSH会拒绝密钥验证；
3. **CRT兼容方式**：CRT可关联本地私钥（`id_rsa`），配置“Public Key”验证，保存会话后一键免密登录；
4. **私钥保管**：私钥丢失则无法登录服务器，建议本地备份一份（如存U盘），但绝不能传给他人；
5. **操作顺序**：必须先测试免密登录成功，再关闭密码登录（避免配置错误导致无法登录）。